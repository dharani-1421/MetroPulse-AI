<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetroPulse AI | Sustainable City Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        #map {
            height: 100%;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
        }

        .active-tab {
            background: #0f172a !important;
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.2);
        }

        .alert-pulse {
            animation: alert-shadow 2s infinite;
            border: 2px solid #ef4444 !important;
        }

        @keyframes alert-shadow {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .mic-active {
            color: #ef4444 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .chat-mic-active {
            color: #ef4444 !important;
            animation: pulse 1s infinite;
            background-color: #fee2e2 !important;
        }

        /* --- CHAT BOT STYLES --- */
        #chat-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #chat-window {
            width: 350px;
            height: 450px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: none;
            flex-direction: column;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .chat-header {
            background: #0f172a;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            font-size: 13px;
            line-height: 1.5;
        }

        .msg-ai {
            background: #f1f5f9;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .msg-user {
            background: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        #chat-toggle {
            width: 60px;
            height: 60px;
            background: #0f172a;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.3);
            transition: transform 0.3s;
        }

        #chat-toggle:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body class="overflow-hidden">
    <div class="flex h-screen w-full p-4 gap-4">
        <div class="w-80 sidebar rounded-[2.5rem] p-8 flex flex-col justify-between shadow-sm">
            <div>
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-black text-slate-900 tracking-tighter">MetroPulse <span
                            class="text-blue-600">AI</span></h1>
                </div>

                <nav id="sidebar-nav" class="space-y-2 mb-6">
                    <button onclick="switchTab('dashboard')"
                        class="w-full text-left px-5 py-3 rounded-2xl transition-all flex items-center gap-3 active-tab"
                        id="btn-dashboard"><span>üèôÔ∏è</span> City Overview</button>
                    <button onclick="switchTab('energy')"
                        class="w-full text-left px-5 py-3 rounded-2xl transition-all flex items-center gap-3 hover:bg-slate-50 text-slate-600 font-semibold"
                        id="btn-energy"><span>‚ö°</span> Energy Resilience</button>
                    <button onclick="switchTab('water')"
                        class="w-full text-left px-5 py-3 rounded-2xl transition-all flex items-center gap-3 hover:bg-slate-50 text-slate-600 font-semibold"
                        id="btn-water"><span>üíß</span> Aqua Resource Mgmt</button>
                    <button onclick="switchTab('traffic')"
                        class="w-full text-left px-5 py-3 rounded-2xl transition-all flex items-center gap-3 hover:bg-slate-50 text-slate-600 font-semibold"
                        id="btn-traffic"><span>üö¶</span> Smart Mobility AI</button>
                </nav>

                <div id="emergency-panel"
                    class="p-4 rounded-3xl bg-slate-50 border border-slate-100 transition-all duration-500">
                    <div class="flex items-center gap-2 mb-2">
                        <span id="alert-dot" class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <p id="alert-status-text"
                            class="text-[10px] font-bold uppercase tracking-widest text-slate-500">SYSTEM OPTIMAL</p>
                    </div>
                    <h4 id="alert-title" class="text-xs font-black text-slate-900 mb-1 tracking-tight">Urban Pattern
                        Clear</h4>
                    <p id="alert-msg" class="text-[10px] text-slate-500 leading-tight mb-3 italic">Autonomous monitoring
                        active.</p>

                    <div class="p-3 bg-white/50 rounded-xl border border-slate-100">
                        <p class="text-[9px] font-bold text-blue-600 uppercase mb-1">AI Future Forecast:</p>
                        <p id="weather-forecast" class="text-[10px] font-medium text-slate-700">Predicting trends...</p>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div id="ai-rec-container" class="p-5 rounded-3xl bg-slate-50">
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-2 text-blue-600">
                        Cognitive AI Engine</p>
                    <p id="ai-rec" class="text-xs leading-relaxed font-bold text-slate-800 italic">Ready for analysis...
                    </p>
                </div>
                <p id="clock" class="text-center text-xs font-bold text-slate-400 font-mono tracking-tighter"></p>
            </div>
        </div>

        <div class="flex-1 flex flex-col gap-4">
            <div class="h-[60%] relative group">
                <div id="map"></div>
                <div class="absolute top-6 left-1/2 -translate-x-1/2 z-[1000] w-[450px]">
                    <div
                        class="glass-card px-4 py-2 rounded-full shadow-2xl flex items-center gap-3 border-none bg-white/95">
                        <span class="text-slate-400">üîç</span>
                        <input type="text" id="location-search" placeholder="Search City Area (e.g. Erode, T.Nagar)"
                            class="flex-1 bg-transparent border-none outline-none text-sm font-semibold text-slate-700">
                        <button onclick="startVoiceRecognition()" id="mic-btn"
                            class="p-2 hover:bg-slate-100 rounded-full transition-all">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 5v4m0 0H8m4 0h4m-4-12a3 3 0 11-6 0 3 3 0 016 0z">
                                </path>
                            </svg>
                        </button>
                        <button onclick="handleSearch()"
                            class="bg-slate-900 text-white px-4 py-1.5 rounded-full text-xs font-bold hover:bg-blue-600 transition-all">Scan</button>
                    </div>
                </div>

                <div
                    class="absolute top-6 left-6 z-[1000] glass-card px-6 py-4 rounded-3xl shadow-2xl border-none pointer-events-none">
                    <p id="place-name" class="text-lg font-black text-slate-900">Locating...</p>
                    <div class="flex gap-4 mt-2">
                        <span class="text-[10px] font-bold text-slate-500">LAT: <span id="lat-val"
                                class="text-blue-600">--</span></span>
                        <span class="text-[10px] font-bold text-slate-500">LNG: <span id="lng-val"
                                class="text-blue-600">--</span></span>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex gap-4">
                <div class="w-1/3 glass-card rounded-[2.5rem] p-8 flex flex-col justify-between border-none shadow-sm">
                    <div>
                        <h3 class="text-slate-400 text-[10px] font-black uppercase tracking-widest" id="score-title">
                            Sustainability Index</h3>
                        <p id="score-val" class="text-6xl font-black mt-2 text-slate-900">--<span
                                class="text-2xl text-slate-300 ml-1">%</span></p>
                        <span id="health-tag"
                            class="mt-3 inline-block px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest">Optimizing</span>
                    </div>
                    <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div id="score-bar" class="h-full bg-slate-900 transition-all duration-1000"></div>
                    </div>
                </div>

                <div class="flex-1 glass-card rounded-[2.5rem] p-8 border-none shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-slate-400 text-[10px] font-black uppercase tracking-widest" id="chart-title">AI
                            Sensor Analysis</h3>
                        <div class="flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full">
                            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span>
                            <span class="text-[9px] text-slate-600 font-black uppercase">Live Analytics Feed</span>
                        </div>
                    </div>
                    <div class="h-40"><canvas id="mainChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-window" class="flex">
            <div class="chat-header">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="font-bold text-sm tracking-tight">UrbanAI Assistant</span>
                </div>
                <button onclick="toggleChat()" class="text-white/50 hover:text-white">‚úï</button>
            </div>
            <div id="chat-messages">
                <div class="msg msg-ai">Hello! I'm MetroPulse AI. I can analyze traffic, energy, or sustainability for
                    any area on the map.</div>
            </div>
            <div class="p-4 border-t flex gap-2 items-center">
                <input type="text" id="chat-input" placeholder="Ask about this area..."
                    class="flex-1 text-xs border-none outline-none p-2 bg-slate-50 rounded-lg h-9">
                <button onclick="startChatVoice()" id="chat-mic-btn"
                    class="p-2 bg-slate-100/50 hover:bg-slate-200 rounded-lg transition-all text-slate-500 hover:text-slate-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 5v4m0 0H8m4 0h4m-4-12a3 3 0 11-6 0 3 3 0 016 0z">
                        </path>
                    </svg>
                </button>
                <button onclick="sendChatMessage()"
                    class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 transition-colors">Send</button>
            </div>
        </div>
        <div id="chat-toggle" onclick="toggleChat()">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                </path>
            </svg>
        </div>
    </div>

    <script>
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([13.0827, 80.2707], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var mainMarker = L.marker([13.0827, 80.2707], { draggable: true }).addTo(map);
        var currentTab = 'dashboard';
        var mainChart;
        var cityState = {
            area: "Locating...",
            lat: 13.0827,
            lng: 80.2707,
            sustainability: 0,
            traffic: 0,
            energy: 0,
            water: 0,
            aqi: 45,
            waste: 60,
            forecast: "Predicting trends..."
        };

        async function handleSearch() {
            const query = document.getElementById('location-search').value;
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=in&limit=1`);
                const data = await res.json();
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.flyTo([lat, lon], 14, { animate: true, duration: 1.5 });
                    mainMarker.setLatLng([lat, lon]);
                    updateLocationData(lat, lon);
                } else { alert("Location not found."); }
            } catch (e) { console.error("Search failed"); }
        }

        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.onstart = () => { document.getElementById('mic-btn').classList.add('mic-active'); };
            recognition.onresult = (event) => { document.getElementById('location-search').value = event.results[0][0].transcript; handleSearch(); };
            recognition.onend = () => { document.getElementById('mic-btn').classList.remove('mic-active'); };
            recognition.start();
        }

        async function updateLocationData(lat, lng) {
            cityState.lat = lat;
            cityState.lng = lng;
            const titleMap = {
                'dashboard': 'Sustainability Index',
                'energy': 'Energy Resilience Index',
                'water': 'Aqua Purity & Flow Index',
                'traffic': 'Mobility Efficiency Index'
            };
            document.getElementById('score-title').innerText = titleMap[currentTab];
            document.getElementById('lat-val').innerText = lat.toFixed(4);
            document.getElementById('lng-val').innerText = lng.toFixed(4);

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                var area = data.address.suburb || data.address.neighbourhood || data.address.city || data.display_name.split(',')[0] || "Target Zone";
                document.getElementById('place-name').innerText = area;
                cityState.area = area;
            } catch (e) {
                document.getElementById('place-name').innerText = "Analyzing Area...";
                cityState.area = "Monitored Zone";
            }

            const seed = (lat + lng) * 1000;
            const riskValue = Math.abs(Math.sin(seed));
            let score, chartData, rec, color, alertObj = null;

            // Simple Simulation Logic & State Update
            if (currentTab === 'traffic') {
                score = Math.floor(25 + (riskValue * 40));
                cityState.traffic = score;
                chartData = [100, 180, 250, 190, 220, 280];
                color = '#ef4444';
                if (score < 35) {
                    alertObj = { title: "GRIDLOCK DETECTED", msg: `Heavy congestion in this area.`, status: "EMERGENCY" };
                    rec = `FIX: Activating signal override.`;
                } else { rec = "Mobility flow optimized."; }
            } else if (currentTab === 'energy') {
                let isShutdown = riskValue < 0.15;
                score = isShutdown ? 0 : Math.floor(65 + (Math.abs(Math.cos(seed)) * 30));
                cityState.energy = score;
                chartData = isShutdown ? [0, 0, 0, 0, 0, 0] : [80, 75, 90, 85, 92, 88];
                color = isShutdown ? '#000000' : '#3b82f6';
                if (isShutdown) {
                    alertObj = { title: "GRID FAILURE", msg: `Power outage detected.`, status: "DANGER" };
                    rec = `FIX: Emergency repair dispatched.`;
                } else { rec = "Energy grid stable."; }
            } else if (currentTab === 'water') {
                score = Math.floor(68 + (riskValue * 25));
                cityState.water = score;
                chartData = [70, 72, 75, 71, 74, 78];
                color = '#3b82f6';
                rec = "Water supply levels optimal.";
            } else {
                score = Math.floor(72 + (riskValue * 20));
                cityState.sustainability = score;
                chartData = [60, 65, 62, 70, 68, 75];
                color = '#10b981';
                rec = "Urban health optimal.";
            }

            // Sync other metrics for demo consistency
            if (!cityState.traffic) cityState.traffic = Math.floor(40 + (riskValue * 20));
            if (!cityState.energy) cityState.energy = Math.floor(70 + (riskValue * 20));
            if (!cityState.water) cityState.water = Math.floor(75 + (riskValue * 15));
            if (!cityState.sustainability) cityState.sustainability = Math.floor(70 + (riskValue * 20));

            cityState.forecast = riskValue > 0.7 ? "Tomorrow: Rain Expected." : "Tomorrow: Clear Skies.";
            document.getElementById('weather-forecast').innerText = cityState.forecast;
            updateUI(score, color, rec, alertObj);
            updateChart(chartData, color);
        }

        function updateUI(score, color, rec, alert) {
            document.getElementById('score-val').innerHTML = `${score}<span class="text-2xl text-slate-300 ml-1 font-normal">%</span>`;
            document.getElementById('score-bar').style.width = score + "%";
            document.getElementById('score-bar').style.backgroundColor = color;
            document.getElementById('ai-rec').innerText = rec;
            const panel = document.getElementById('emergency-panel');
            const dot = document.getElementById('alert-dot');
            const statusText = document.getElementById('alert-status-text');
            const title = document.getElementById('alert-title');
            const msg = document.getElementById('alert-msg');
            const tag = document.getElementById('health-tag');

            if (alert) {
                panel.className = "p-4 rounded-3xl bg-red-50 alert-pulse";
                dot.className = "w-2 h-2 bg-red-600 rounded-full animate-ping";
                statusText.innerText = alert.status; statusText.className = "text-[10px] font-black text-red-600";
                title.innerText = alert.title; msg.innerText = alert.msg;
                tag.innerText = "CRITICAL"; tag.style.background = "#fee2e2"; tag.style.color = "#ef4444";
            } else {
                panel.className = "p-4 rounded-3xl bg-slate-50 border border-slate-100";
                dot.className = "w-2 h-2 bg-green-500 rounded-full";
                statusText.innerText = "SYSTEM OPTIMAL"; statusText.className = "text-[10px] font-bold text-slate-500";
                title.innerText = "Urban Pattern Clear"; msg.innerText = "Autonomous monitoring active.";
                tag.innerText = "OPTIMIZED"; tag.style.background = "#dcfce7"; tag.style.color = "#10b981";
            }
        }

        // Map events
        mainMarker.on('dragend', () => updateLocationData(mainMarker.getLatLng().lat, mainMarker.getLatLng().lng));
        map.on('click', (e) => { mainMarker.setLatLng(e.latlng); updateLocationData(e.latlng.lat, e.latlng.lng); });

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById('btn-' + tab).classList.add('active-tab');
            updateLocationData(mainMarker.getLatLng().lat, mainMarker.getLatLng().lng);
        }

        function updateChart(dataPoints, color) {
            if (mainChart) mainChart.destroy();
            var ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['-5h', '-4h', '-3h', '-2h', '-1h', 'NOW'],
                    datasets: [{ data: dataPoints, borderColor: color, borderWidth: 4, fill: true, backgroundColor: color + '11', tension: 0.4, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        /* --- UPDATED DYNAMIC CHAT LOGIC --- */
        function toggleChat() {
            const window = document.getElementById('chat-window');
            window.style.display = (window.style.display === 'none' || window.style.display === '') ? 'flex' : 'none';
        }

        function startChatVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Voice recognition not supported in this browser.");
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            const micBtn = document.getElementById('chat-mic-btn');

            recognition.onstart = () => { micBtn.classList.add('chat-mic-active'); };
            recognition.onresult = (event) => {
                document.getElementById('chat-input').value = event.results[0][0].transcript;
                // sendChatMessage(); // Automatically send after voice (optional)
            };
            recognition.onend = () => { micBtn.classList.remove('chat-mic-active'); };
            recognition.start();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';

            const lowText = text.toLowerCase();
            const thinkingMsg = addMessage("Thinking...", 'ai'); // Add thinking indicator

            let targetArea = cityState.area;
            let targetMetrics = cityState;
            let isNewLocation = false;

            // Location Detection Logic (e.g., "in Mumbai", "for Chennai")
            const locRegex = /(?:in|at|for|about|to|near|of|around|show)\s+([a-zA-Z\s]{3,})/i;
            const locMatch = text.match(locRegex);

            if (locMatch) {
                const foundLoc = locMatch[1].replace(/\?|\.|!/g, '').trim();
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${foundLoc}&countrycodes=in&limit=1`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        targetMetrics = calculateMetrics(lat, lon);
                        targetArea = data[0].display_name.split(',')[0];
                        isNewLocation = true;
                        window.lastDiscussedCoords = { lat, lon, name: targetArea };
                    }
                } catch (e) { console.error("Chat search failed"); }
            }

            setTimeout(() => {
                thinkingMsg.remove(); // Clear thinking bubble
                let response = "";
                const { traffic, energy, water, sustainability, aqi, waste, forecast } = targetMetrics;

                // Priority: Navigation commands
                if (lowText.includes('fly') || lowText.includes('go to') || lowText.includes('navigate') || (lowText.includes('show') && isNewLocation)) {
                    if (window.lastDiscussedCoords) {
                        map.flyTo([window.lastDiscussedCoords.lat, window.lastDiscussedCoords.lon], 14, { duration: 2 });
                        mainMarker.setLatLng([window.lastDiscussedCoords.lat, window.lastDiscussedCoords.lon]);
                        updateLocationData(window.lastDiscussedCoords.lat, window.lastDiscussedCoords.lon);
                        response = `Certainly! Navigating to **${window.lastDiscussedCoords.name}** now. Dashboard metrics are syncing.`;
                        addMessage(response, 'ai');
                        return;
                    }
                }

                // Data Queries
                if (lowText.includes('traffic') || lowText.includes('congestion') || lowText.includes('mobility')) {
                    response = `For **${targetArea}**, mobility efficiency is **${traffic}%**. ${traffic < 40 ? "Congestion alert detected." : "Flow is stable."}`;
                }
                else if (lowText.includes('energy') || lowText.includes('power')) {
                    response = `Energy Resilience for **${targetArea}** is **${energy}%**.`;
                }
                else if (lowText.includes('water') || lowText.includes('aqua')) {
                    response = `Aqua resource management score for **${targetArea}** is **${water}%**.`;
                }
                else if (lowText.includes('sustainability') || lowText.includes('index')) {
                    response = `The integrated Sustainability Index for **${targetArea}** is **${sustainability}%**.`;
                }
                else if (lowText.includes('weather') || lowText.includes('forecast')) {
                    response = `Forecast for **${targetArea}**: ${forecast}`;
                }
                else if (isNewLocation) {
                    response = `I've retrieved data for **${targetArea}**. Sustainability: ${sustainability}%, Traffic: ${traffic}%. Would you like to see this area on the map?`;
                }
                else if (lowText.includes('hello') || lowText.includes('hi')) {
                    response = "Hello! I am MetroPulse AI. I can fetch city data for any location in India. What can I help you with?";
                }
                else {
                    response = `I'm analyzing **${targetArea}**. I can provide info on Traffic (${traffic}%), Energy (${energy}%), or Sustainability (${sustainability}%).`;
                }

                addMessage(response, 'ai');
            }, 800);
        }

        function addMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        document.getElementById('location-search').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        switchTab('dashboard');
    </script>
</body>

</html>